<!--
    Prompt Builder Web App

    This single‑page application replicates the functionality of the
    original Tkinter desktop prompt builder in a form that runs
    entirely within a modern web browser like Chrome.  It allows
    users to assemble richly detailed prompts for AI image generation
    (MidJourney, Stable Diffusion, Google Whisk, etc.) by selecting
    from a comprehensive set of cinematic options.  The interface
    includes free‑text fields, single‑choice dropdowns, multi‑select
    lists with helpful tooltips, and preset storage using browser
    local storage.  A dark theme ensures comfortable use for long
    editing sessions.

    Usage:
      1. Open this HTML file in your web browser (e.g. double‑click it
         or drag it into a Chrome window).
      2. Fill in the subject/action and mood fields.
      3. Choose your desired options from the dropdowns and
         multi‑select lists.  Hold Ctrl (or Cmd on Mac) to select
         multiple entries in the multi‑select lists.
      4. Click "Generate Prompt" to assemble the descriptive
         paragraph along with extra metadata.  The result will
         appear in the output area below.
      5. Click "Copy Prompt" to copy the generated prompt to your
         clipboard.
      6. To save the current configuration as a preset, enter a
         preset name and click "Save Preset".  Saved presets are
         stored in your browser's local storage and are automatically
         listed in the "Load Preset" dropdown on future visits.

    Notes:
      * The default presets (10 examples) demonstrate a variety of
        cinematic scenes and serve as inspiration.  You can delete
        or modify them by editing the DEFAULT_PRESETS constant in the
        script below.
      * Grammar and orthography are lightly tidied when generating
        the prompt (e.g. trimming extra spaces and capitalising the
        first letter).  For more advanced text polishing, you may
        paste the result into your favourite editor or AI assistant.
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated title to give the app a more memorable identity -->
    <title>CinePrompt Studio</title>
    <style>
        /* Dark theme styling */
        body {
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0 20px;
        }
        h1 {
            color: #ffffff;
            text-align: center;
            margin-top: 20px;
        }
        label {
            display: block;
            margin-top: 12px;
            margin-bottom: 4px;
            font-weight: bold;
        }
        input[type="text"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #2a2a2a;
            color: #d4d4d4;
            box-sizing: border-box;
        }
        select[multiple] {
            height: 100px;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        .container {
            max-width: 960px;
            margin: 0 auto;
        }
        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .col {
            flex: 1 1 280px;
            min-width: 260px;
        }
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 16px;
            margin-top: 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005fa3;
        }
        .output {
            margin-top: 20px;
        }
        .preset-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .preset-controls input {
            flex: 1 1 auto;
        }
        .tooltip {
            position: relative;
        }
        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: left;
            border-radius: 4px;
            padding: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Updated heading to reflect the new name -->
        <h1>CinePrompt Studio</h1>
        <!-- Camera settings come first -->
        <!-- Row for camera/lens selections and framing/aspect ratio.  
             Each of the first two columns contains a pair of dropdowns.  
             Tooltips explain how to interact with the nested selects. -->
        <div class="row">
            <div class="col tooltip">
                <label for="camera_type">Camera</label>
                <!-- First dropdown selects the category of camera (film, photo/digital, phone or other).  
                     When a category is chosen the second dropdown below updates to list the appropriate models. -->
                <select id="camera_type"></select>
                <select id="camera"></select>
                <span class="tooltiptext">Choose a camera category (film, photo/digital, phone or other) and then select a specific model.</span>
            </div>
            <div class="col tooltip">
                <label for="lens_type">Lens / Focal Length</label>
                <!-- Similar to camera, the lens selection is split into type and specific focal length.  
                     Selecting a lens type will populate the second dropdown with relevant focal lengths or lens names. -->
                <select id="lens_type"></select>
                <select id="lens"></select>
                <span class="tooltiptext">Select a lens category (standard, zoom, macro, artistic, phone, etc.) followed by a focal length or lens name.</span>
            </div>
            <div class="col tooltip">
                <label for="framing">Shot Framing</label>
                <select id="framing"></select>
                <span class="tooltiptext">Choose the general orientation of the frame (vertical, horizontal, square).</span>
            </div>
            <div class="col tooltip">
                <label for="aspect_ratio">Aspect Ratio</label>
                <select id="aspect_ratio"></select>
                <span class="tooltiptext">Select the width‑to‑height ratio for the image.</span>
            </div>
        </div>

        <!-- Row for composition, shot size, camera movement and lighting -->
        <div class="row">
            <div class="col tooltip">
                <label for="composition">Composition</label>
                <select id="composition" multiple></select>
                <!-- Provide a custom composition field for additional rules not listed -->
                <input type="text" id="compositionDetails" placeholder="Custom composition (optional)" style="margin-top:4px;">
                <span class="tooltiptext">Select one or more composition rules (use Ctrl/Cmd for multi‑select) or enter your own composition below.</span>
            </div>
            <div class="col tooltip">
                <label for="shot_size">Shot Size</label>
                <select id="shot_size"></select>
                <input type="text" id="shotSizeDetails" placeholder="Shot size details (optional)" style="margin-top:4px;">
                <span class="tooltiptext">Choose how close or wide the camera frames the subject, or specify a custom shot size.</span>
            </div>
            <div class="col tooltip">
                <label for="camera_move">Camera Movement</label>
                <!-- Allow multiple camera movements -->
                <select id="camera_move" multiple></select>
                <input type="text" id="cameraMoveDetails" placeholder="Camera movement details (optional)" style="margin-top:4px;">
                <span class="tooltiptext">Select one or more camera moves (use Ctrl/Cmd for multi‑select) and optionally provide further detail.</span>
            </div>
            <div class="col tooltip">
                <label for="lighting">Lighting Time</label>
                <select id="lighting"></select>
                <input type="text" id="lightingDetails" placeholder="Lighting details (optional)" style="margin-top:4px;">
                <span class="tooltiptext">Select the time of day or lighting condition. Additional details can be provided below.</span>
            </div>
        </div>

        <!-- Row for weather, colour mood, film texture and environment -->
        <div class="row">
            <div class="col">
                <label for="weather">Weather / Atmosphere</label>
                <select id="weather"></select>
                <input type="text" id="weatherDetails" placeholder="Weather details (optional)" style="margin-top:4px;">
            </div>
            <div class="col">
                <label for="color_mood">Color Mood</label>
                <select id="color_mood"></select>
                <input type="text" id="colorMoodDetails" placeholder="Color mood details (optional)" style="margin-top:4px;">
            </div>
            <div class="col tooltip">
                <label for="film_texture">Film Texture</label>
                <select id="film_texture" multiple></select>
                <span class="tooltiptext">Hold Ctrl (or Cmd) to select multiple textures.</span>
                <input type="text" id="filmTextureDetails" placeholder="Film texture details (optional)" style="margin-top:4px;">
            </div>
            <div class="col">
                <label for="environment">Environment</label>
                <select id="environment"></select>
                <input type="text" id="environmentDetails" placeholder="Environment details (optional)" style="margin-top:4px;">
            </div>
        </div>

        <!-- Row for era/style, motion cues, reflections and people density -->
        <div class="row">
            <div class="col">
                <label for="era_style">Era / Styling</label>
                <select id="era_style"></select>
                <input type="text" id="eraStyleDetails" placeholder="Era/style details (optional)" style="margin-top:4px;">
            </div>
            <div class="col tooltip">
                <label for="motion_cues">Motion Cues</label>
                <select id="motion_cues" multiple></select>
                <span class="tooltiptext">Hold Ctrl (or Cmd) to select multiple motion cues.</span>
                <input type="text" id="motionCuesDetails" placeholder="Motion cues details (optional)" style="margin-top:4px;">
            </div>
            <div class="col">
                <label for="reflections">Reflections / Surfaces</label>
                <select id="reflections" multiple></select>
                <input type="text" id="reflectionsDetails" placeholder="Reflections details (optional)" style="margin-top:4px;">
            </div>
            <div class="col">
                <label for="people_density">People Density</label>
                <select id="people_density"></select>
                <input type="text" id="peopleDensityDetails" placeholder="People density details (optional)" style="margin-top:4px;">
            </div>
        </div>

        <!-- Row for negative elements -->
        <div class="row">
            <div class="col tooltip">
                <label for="negative-checkboxes">Negative Elements</label>
                <!-- Replace multi‑select with a group of checkboxes for negative prompts -->
                <div id="negative-checkboxes" class="mood-checkboxes" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                <input type="text" id="negativeDetails" placeholder="Additional negative prompts (optional)" style="margin-top:4px; width:100%;">
                <span class="tooltiptext">Choose any number of negative prompts and/or enter your own to exclude unwanted elements.</span>
            </div>
            <div class="col" style="flex: 1 1 100%;">
                <!-- Empty cell for spacing -->
            </div>
        </div>

        <!-- Subject and mood inputs moved below camera settings -->
        <label for="subject">Subject / Action</label>
        <!-- Subject text area: auto-grow as the user types.  Min height set to approximately five lines but will expand dynamically on input. -->
        <textarea id="subject" placeholder="Describe the main subject and action…" style="resize: vertical; overflow-y: hidden; min-height: 120px;"></textarea>

        <label for="mood-details">Mood / Atmosphere</label>
        <div id="mood-checkboxes" class="mood-checkboxes" style="display:flex; flex-wrap:wrap; gap:8px;">
            <label><input type="checkbox" value="Romantic"> Romantic</label>
            <label><input type="checkbox" value="Dark"> Dark</label>
            <label><input type="checkbox" value="Light-hearted"> Light-hearted</label>
            <label><input type="checkbox" value="Mysterious"> Mysterious</label>
            <label><input type="checkbox" value="Melancholic"> Melancholic</label>
            <label><input type="checkbox" value="Whimsical"> Whimsical</label>
            <label><input type="checkbox" value="Epic"> Epic</label>
            <label><input type="checkbox" value="Hopeful"> Hopeful</label>
            <label><input type="checkbox" value="Nostalgic"> Nostalgic</label>
        </div>
        <input type="text" id="moodDetails" placeholder="Mood details (optional)" style="margin-top:4px; width:100%;">

        <!-- Buttons -->
        <button id="generateBtn">Generate Prompt</button>
        <button id="copyBtn">Copy Prompt</button>
        <!-- Inline copy message shown briefly when copy occurs -->
        <span id="copyMessage" style="display:none; color: lightgreen; margin-left:10px; font-size:0.9em; vertical-align: middle;">Copied!</span>
        <button id="clearBtn">Clear All</button>

        <!-- Preset controls -->
        <div style="margin-top: 24px;">
            <label for="preset_select">Load Preset</label>
            <select id="preset_select"></select>
            <button id="loadPresetBtn">Load</button>
            <div class="preset-controls">
                <input type="text" id="preset_name" placeholder="Preset name…">
                <button id="savePresetBtn">Save Preset</button>
            </div>
        </div>

        <!-- Output area -->
        <div class="output">
            <label for="output">Generated Prompt</label>
            <textarea id="output" readonly></textarea>
        </div>
    </div>

    <script>
    // Data definitions corresponding to the Python script
    // Camera lists organised by type.  Film cameras draw from influential historical models,
    // digital cameras cover popular DSLRs/mirrorless systems, and phone cameras include
    // early camera phones from the 2000s and modern smartphones.  Sources include
    // descriptions of iconic early camera phones like the Samsung SCH‑V200, Sharp J-SH04,
    // Sanyo SCP-5300, Audiovox PM8920, Nokia N90, Sony Ericsson K750i/K800i, Nokia N95
    // and Samsung INNOV8【514609640034993†L271-L283】【466617726925691†L126-L134】.
    // Camera models by category.  Film, digital (photo) and phone lists are used when the user picks a camera type.
    const FILM_CAMERAS = [
        "Daguerreotype (1839)", "The Kodak (1888)", "Kodak Brownie (1900)",
        "Graflex Speed Graphic (1912)", "Leica I (1925)", "Kine Exakta I (1936)",
        "Hasselblad 1600F (1948)", "Leica M3 (1954)", "Nikon F (1959)",
        "Canon AE-1 (1976)", "Olympus OM-1 (1973)", "Olympus OM-2 (1975)",
        "Canon T90 (1986)", "Nikon F3 (1980)", "Pentax Spotmatic (1964)"
    ];
    const DIGITAL_CAMERAS = [
        "Kodak DCS 100 (1992)", "Canon EOS-1Ds (2002)", "Nikon D1 (1999)",
        "Canon 5D Mark II (2008)", "Nikon D3 (2007)", "Sony a7 (2013)",
        "Sony a9 (2017)", "Canon 5D Mark IV (2016)", "Nikon Z6 (2018)",
        "Fujifilm X-T4 (2020)", "Canon R5 (2020)", "Nikon Z9 (2021)", "Sony Alpha 1 (2021)"
    ];
    const PHONE_CAMERAS = [
        "Samsung SCH-V200 (2000)", "Sharp J-SH04 (2000)", "Sanyo SCP-5300 (2002)",
        "Audiovox PM8920 (2004)", "Nokia N90 (2005)", "Sony Ericsson K750i (2005)",
        "Sony Ericsson K800i (2006)", "Nokia N95 (2007)", "Samsung INNOV8 (2008)",
        "Samsung Galaxy Note 3 (2013)", "LG G3 (2014)", "iPhone 6s (2015)",
        "iPhone 8 (2017)", "Samsung Galaxy S9 (2018)", "OnePlus 6 (2018)",
        "Samsung Galaxy S20 (2020)", "Redmi K30 Pro (2020)", "iPhone 12 Pro (2020)"
    ];

    // Additional camera models for the "Other" category (drones, action cams and unusual devices).
    const OTHER_CAMERAS = [
        "GoPro HERO10 (2021)", "DJI Phantom 4 (2016)", "DJI Mavic 3 (2021)", "Blackmagic Pocket Cinema Camera 6K (2019)",
        "360° Ricoh Theta Z1 (2019)", "Thermal camera", "Security CCTV", "Polaroid camera"
    ];

    // Top‑level camera categories shown in the first dropdown.  The "Photo" category corresponds to digital cameras.
    const CAMERA_TYPES = ["Film", "Photo", "Phone", "Other"];

    // Lookup mapping camera type to specific camera lists.
    const CAMERAS_BY_TYPE = {
        Film: FILM_CAMERAS,
        Photo: DIGITAL_CAMERAS,
        Phone: PHONE_CAMERAS,
        Other: OTHER_CAMERAS
    };

    // Lens lists organised by type.  Each group includes a "None" option that is added later
    // when populating the select element.
    // Lens focal lengths and types organised into categories.  Users select a lens type and then a specific lens or focal length.
    const LENS_TYPES = {
        "Standard": ["24mm", "28mm", "35mm", "50mm", "85mm", "135mm"],
        "Zoom": ["18-55mm", "24-70mm", "24-105mm", "70-200mm", "100-400mm"],
        "Macro": ["Macro", "Micro"],
        "Artistic": ["Anamorphic", "Fisheye", "Tilt-shift", "Soft focus", "Lensbaby"],
        "Phone": ["Wide", "Ultra-wide", "Telephoto", "Macro", "Periscope", "Depth sensor", "Monochrome", "Front camera"],
        "Vintage": ["Vintage", "Polaroid"]
    };
    const FRAMINGS = ["Vertical", "Horizontal", "Square"];
    const ASPECT_RATIOS = ["3:2", "4:3", "16:9", "9:16", "1:1", "2.39:1"];
    // Extend composition options with additional classic photographic rules
    const COMPOSITIONS = [
        { name: "Rule of thirds", desc: "Place key elements along the thirds of the frame" },
        { name: "Centered", desc: "Subject is centred within the frame" },
        { name: "Leading lines", desc: "Compositional lines guide the viewer's eye" },
        { name: "Negative space", desc: "Large areas of empty space around the subject" },
        { name: "Symmetry", desc: "Balanced elements mirrored across an axis" },
        { name: "Dutch angle", desc: "Frame is tilted for dynamic tension" },
        { name: "Golden ratio", desc: "Elements follow the spiral proportions of the golden ratio" },
        { name: "Frame within a frame", desc: "Use natural or architectural frames around the subject" },
        { name: "Patterns & repetition", desc: "Highlight repeating shapes or forms" },
        { name: "Minimalism", desc: "Use a simple composition with few elements" },
        { name: "Triangular composition", desc: "Arrange subjects to form a triangle for balance" }
    ];
    // Extend shot sizes with group and specialty shots
    const SHOT_SIZES = [
        { name: "Extreme close-up (ECU)", desc: "Focus on a small detail like eyes or hands" },
        { name: "Close-up (CU)", desc: "Head and shoulders of a person" },
        { name: "Medium close-up (MCU)", desc: "Chest up of a person" },
        { name: "Medium shot (MS)", desc: "Waist up of a person" },
        { name: "Medium long shot (MLS)", desc: "Knees up of a person" },
        { name: "Wide shot (WS)", desc: "Full body or subject in environment" },
        { name: "Extreme wide shot (EWS)", desc: "Landscape or very wide view" },
        { name: "Cowboy shot (CS)", desc: "From mid-thigh to head of a person" },
        { name: "Full shot (FS)", desc: "Entire body of a person" },
        { name: "Establishing shot (ES)", desc: "Wide view showing context" },
        { name: "Medium wide shot (MWS)", desc: "Shows subject from knees up with some environment" },
        { name: "Over-the-shoulder (OTS)", desc: "Frame over the shoulder of a subject" },
        { name: "Point-of-view (POV)", desc: "Shows what a character sees" },
        { name: "Two-shot", desc: "Includes two subjects in a balanced composition" },
        { name: "Three-shot", desc: "Includes three subjects in the frame" },
        { name: "Group shot", desc: "Captures several subjects together" }
    ];
    // Expand camera movement list and switch to multi-select.  These items describe many common cinematic moves.
    const CAMERA_MOVES = [
        { name: "Static", desc: "No camera movement" },
        { name: "Pan", desc: "Rotate horizontally from a fixed point" },
        { name: "Tilt", desc: "Rotate vertically from a fixed point" },
        { name: "Push-in", desc: "Move camera closer to subject" },
        { name: "Pull-out", desc: "Move camera away from subject" },
        { name: "Dolly", desc: "Move camera on a track towards or away" },
        { name: "Truck", desc: "Move camera sideways on a track" },
        { name: "Handheld", desc: "Unstable, free camera movement" },
        { name: "Steadicam", desc: "Smooth stabilised handheld movement" },
        { name: "Pedestal", desc: "Raise or lower camera vertically" },
        { name: "Roll", desc: "Rotate camera along the lens axis" },
        { name: "Crane", desc: "Move camera vertically using a crane or jib" },
        { name: "Aerial", desc: "High‑angle movement from a drone or helicopter" },
        { name: "Tracking shot", desc: "Follow the subject along a path" },
        { name: "Arc shot", desc: "Move around the subject in an arc" },
        { name: "Dolly zoom", desc: "Simultaneous zoom and dolly creating perspective distortion" },
        { name: "360-degree pan", desc: "Rotate the camera in a full circle" }
    ];
    // Lighting times expanded with more specific times of day
    const LIGHTING_TIMES = ["Golden hour", "Blue hour", "Morning", "Noon", "Afternoon", "Evening", "Night", "Dawn", "Sunrise", "Sunset", "Twilight", "Midnight", "Magic hour"];
    const WEATHERS = ["Clear", "Cloudy", "Fog", "Drizzle", "Rain", "Snow", "Haze", "Mist", "Backlit dust"];
    // Colour moods as objects with descriptions; extended to include additional tonal palettes
    const COLOR_MOODS = [
        { name: "Warm", desc: "Emphasises reds, oranges and yellows for a cosy feel" },
        { name: "Cool", desc: "Emphasises blues and greens for a calm, detached feel" },
        { name: "Teal-orange", desc: "High contrast mix of teal shadows and orange highlights" },
        { name: "Muted", desc: "Desaturated colours for a subdued mood" },
        { name: "Monochrome", desc: "Single hue or black and white palette" },
        { name: "Vibrant", desc: "Highly saturated colours for energy and excitement" },
        { name: "Pastel", desc: "Soft, delicate colours for a dreamlike atmosphere" },
        { name: "High contrast", desc: "Strong tonal differences between light and dark areas" },
        { name: "Bleak", desc: "Desaturated and cold tones for a somber feel" },
        { name: "Colourful", desc: "Rich, varied hues with high saturation" },
        { name: "Earth tones", desc: "Browns, greens and natural hues for grounded scenes" }
    ];
    const FILM_TEXTURES = ["35mm grain", "16mm grain", "Light leak", "Halation", "Bloom", "Chromatic aberration", "VHS", "Polaroid", "Dust & scratches", "Sepia tone", "Film burn", "Bokeh", "Sprocket holes"];
    const ENVIRONMENTS = ["Urban", "Suburban", "Coastal", "Forest", "Desert", "Mountain", "Indoor", "Industrial", "Rural", "Futuristic", "Vintage"];
    const ERAS_STYLES = ["1870s", "1880s", "1890s", "1900s", "1910s", "1920s", "1930s", "1940s", "1950s", "1960s", "1970s", "1980s", "1990s", "2000s", "2010s", "2020s", "Contemporary"];
    // Additional motion cues to broaden expressive possibilities
    const MOTION_CUES = [
        { name: "Motion blur", desc: "Subject or background blurred by movement" },
        { name: "Long exposure trails", desc: "Light streaks from long exposures" },
        { name: "Freeze action", desc: "Fast shutter to freeze motion" },
        { name: "Time-lapse", desc: "Compresses time into a short sequence" },
        { name: "Slow motion", desc: "Subject captured at high frame rate" },
        { name: "Whip pan", desc: "Rapid camera pan creating a blur" },
        { name: "Parallax", desc: "Foreground and background move at different speeds" },
        { name: "Hyper-lapse", desc: "Long distance time-lapse movement" },
        { name: "Rack focus", desc: "Shift focus between subjects" },
        { name: "Zoom", desc: "Change focal length for dramatic emphasis" },
        { name: "Stop motion", desc: "Animate through sequential still images" },
        { name: "Bullet time", desc: "Time appears to stand still while the camera moves around" },
        { name: "Glitch effect", desc: "Simulated digital artefacts and jitter" },
        { name: "Speed ramping", desc: "Sudden changes between slow and fast motion" },
        { name: "Frame skipping", desc: "Intermittent frame drops to suggest erratic motion" },
        { name: "Stroboscopic", desc: "Rapid flashes freezing motion" },
        { name: "Tilt-shift blur", desc: "Selective focus creates miniature effect" },
        { name: "Reverse motion", desc: "Subject appears to move backwards in time" }
    ];
    const REFLECTIONS = ["Wet pavement", "Glass", "Puddles", "Neon reflections", "Metallic surfaces", "Water", "Mirrors"];
    const PEOPLE_DENSITY = ["Empty", "Sparse", "Normal", "Crowded"];
    // Negative prompts extended with more exclusions
    const NEGATIVE_ELEMENTS = [
        { name: "No watermark", desc: "Exclude watermarks from the output" },
        { name: "No text", desc: "Exclude any text from the image" },
        { name: "No logos", desc: "Avoid brand logos or trademarks" },
        { name: "No distorted faces", desc: "Avoid unnatural face distortions" },
        { name: "No clutter", desc: "Keep the scene free of unnecessary objects" },
        { name: "No reflections", desc: "Remove unwanted reflections or glare" },
        { name: "No violence", desc: "Exclude violent or graphic content" },
        { name: "No grain", desc: "Keep the image smooth and free of film grain" },
        { name: "No background clutter", desc: "Simplify the background" }
    ];

    // Default example presets (10 presets) drawn from the original Python code.
    const DEFAULT_PRESETS = [
        {
            title: "Neo-noir alley",
            data: {
                subject: "A detective in a trench coat walks down a rain-soaked alley, cigarette smoke trailing behind.",
                camera: "Leica M3 (1954)",
                lens: "35mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Leading lines"],
                shot_size: "Medium shot (MS)",
                camera_move: ["Dolly"],
                lighting: "Night",
                weather: "Rain",
                color_mood: "Cool",
                film_texture: ["35mm grain", "Light leak"],
                environment: "Urban",
                era_style: "1980s",
                motion_cues: ["Motion blur"],
                reflections: ["Wet pavement"],
                people_density: "Sparse",
                negative_elements: ["No logos", "No watermark"],
                mood: "Dark and mysterious"
            }
        },
        {
            title: "Sunset desert ride",
            data: {
                subject: "A lone motorcyclist rides across an endless desert at sunset, dust trailing behind.",
                camera: "Hasselblad 1600F (1948)",
                lens: "50mm",
                framing: "Horizontal",
                aspect_ratio: "2.39:1",
                composition: ["Rule of thirds"],
                shot_size: "Wide shot (WS)",
                camera_move: ["Handheld"],
                lighting: "Golden hour",
                weather: "Clear",
                color_mood: "Warm",
                film_texture: ["35mm grain"],
                environment: "Desert",
                era_style: "1970s",
                motion_cues: ["Long exposure trails"],
                reflections: [],
                people_density: "Empty",
                negative_elements: ["No text", "No logos"],
                mood: "Epic and solitary"
            }
        },
        {
            title: "Futuristic cityscape",
            data: {
                subject: "A drone glides between neon-lit skyscrapers in a bustling future metropolis.",
                camera: "Sony a9 (2017)",
                lens: "24-70mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Symmetry"],
                shot_size: "Extreme wide shot (EWS)",
                camera_move: ["Push-in"],
                lighting: "Night",
                weather: "Fog",
                color_mood: "Teal-orange",
                film_texture: ["Halation", "Bloom"],
                environment: "Urban",
                era_style: "2020s",
                motion_cues: ["Freeze action"],
                reflections: ["Neon reflections"],
                people_density: "Crowded",
                negative_elements: ["No watermark"],
                mood: "Energetic and high-tech"
            }
        },
        {
            title: "Pastoral morning",
            data: {
                subject: "A farmer leads a herd of sheep through misty fields at dawn.",
                camera: "Pentax Spotmatic (1964)",
                lens: "85mm",
                framing: "Horizontal",
                aspect_ratio: "4:3",
                composition: ["Rule of thirds"],
                shot_size: "Wide shot (WS)",
                camera_move: ["Static"],
                lighting: "Morning",
                weather: "Mist",
                color_mood: "Muted",
                film_texture: ["16mm grain"],
                environment: "Rural",
                era_style: "1950s",
                motion_cues: ["Freeze action"],
                reflections: ["Puddles"],
                people_density: "Sparse",
                negative_elements: ["No logos", "No clutter"],
                mood: "Calm and nostalgic"
            }
        },
        {
            title: "Industrial dusk",
            data: {
                subject: "Workers leave a sprawling factory complex as smoke stacks silhouetted against the setting sun.",
                camera: "Canon AE-1 (1976)",
                lens: "28mm",
                framing: "Horizontal",
                aspect_ratio: "3:2",
                composition: ["Leading lines", "Dutch angle"],
                shot_size: "Medium long shot (MLS)",
                camera_move: ["Truck"],
                lighting: "Evening",
                weather: "Haze",
                color_mood: "Warm",
                film_texture: ["35mm grain"],
                environment: "Industrial",
                era_style: "1980s",
                motion_cues: ["Motion blur"],
                reflections: [],
                people_density: "Normal",
                negative_elements: ["No text", "No watermark"],
                mood: "Busy and gritty"
            }
        },
        {
            title: "Coastal storm",
            data: {
                subject: "A lighthouse stands firm as waves crash violently against the rocks during a storm.",
                camera: "Canon T90 (1986)",
                lens: "50mm",
                framing: "Vertical",
                aspect_ratio: "3:2",
                composition: ["Centered"],
                shot_size: "Medium shot (MS)",
                camera_move: ["Static"],
                lighting: "Afternoon",
                weather: "Rain",
                color_mood: "Cool",
                film_texture: ["Halation"],
                environment: "Coastal",
                era_style: "1990s",
                motion_cues: ["Long exposure trails"],
                reflections: ["Water"],
                people_density: "Empty",
                negative_elements: ["No logos"],
                mood: "Dramatic and resilient"
            }
        },
        {
            title: "Forest fairytale",
            data: {
                subject: "A child follows a trail of glowing mushrooms through an enchanted forest.",
                camera: "Sony a7 (2013)",
                lens: "35mm",
                framing: "Vertical",
                aspect_ratio: "9:16",
                composition: ["Negative space"],
                shot_size: "Medium close-up (MCU)",
                camera_move: ["Pull-out"],
                lighting: "Blue hour",
                weather: "Fog",
                color_mood: "Pastel",
                film_texture: ["Bloom", "Chromatic aberration"],
                environment: "Forest",
                era_style: "2000s",
                motion_cues: ["Slow motion"],
                reflections: [],
                people_density: "Sparse",
                negative_elements: ["No text", "No watermark"],
                mood: "Whimsical and magical"
            }
        },
        {
            title: "Oceanic exploration",
            data: {
                subject: "Divers swim through crystal clear water among colourful fish and coral.",
                camera: "GoPro HERO10 (2021)",
                lens: "24mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Centered"],
                shot_size: "Wide shot (WS)",
                camera_move: ["Handheld"],
                lighting: "Afternoon",
                weather: "Clear",
                color_mood: "Vibrant",
                film_texture: ["Chromatic aberration"],
                environment: "Coastal",
                era_style: "2020s",
                motion_cues: ["Freeze action"],
                reflections: ["Water"],
                people_density: "Sparse",
                negative_elements: ["No logos", "No watermark"],
                mood: "Adventurous and awe-inspiring"
            }
        },
        {
            title: "Suburban night drive",
            data: {
                subject: "A teenager drives a vintage car through a quiet suburban neighbourhood at night, street lights reflecting off the hood.",
                camera: "Nikon F2 (1971)",
                lens: "50mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Centered", "Leading lines"],
                shot_size: "Medium shot (MS)",
                camera_move: ["Truck"],
                lighting: "Night",
                weather: "Clear",
                color_mood: "Muted",
                film_texture: ["35mm grain"],
                environment: "Suburban",
                era_style: "1990s",
                motion_cues: ["Motion blur"],
                reflections: ["Wet pavement"],
                people_density: "Sparse",
                negative_elements: ["No text", "No logos"],
                mood: "Melancholic and reflective"
            }
        },
        {
            title: "Rural carnival",
            data: {
                subject: "Children ride a brightly lit Ferris wheel at a small town carnival at dusk.",
                camera: "Fujifilm X100V (2020)",
                lens: "23mm",
                framing: "Horizontal",
                aspect_ratio: "3:2",
                composition: ["Symmetry", "Leading lines"],
                shot_size: "Medium long shot (MLS)",
                camera_move: ["Static"],
                lighting: "Evening",
                weather: "Clear",
                color_mood: "Vibrant",
                film_texture: ["35mm grain"],
                environment: "Rural",
                era_style: "2010s",
                motion_cues: ["Long exposure trails"],
                reflections: [],
                people_density: "Crowded",
                negative_elements: ["No logos"],
                mood: "Joyful and nostalgic"
            }
        }
        ,
        // Additional cinematic presets inspired by classic and international films
        {
            title: "The Godfather wedding",
            data: {
                subject: "A classic 1970s wedding banquet with guests in formal wear, warm candlelight illuminating their faces.",
                camera: "Canon AE-1 (1976)",
                lens: "50mm",
                framing: "Horizontal",
                aspect_ratio: "4:3",
                composition: ["Symmetry", "Centered"],
                shot_size: "Group shot",
                camera_move: ["Static"],
                lighting: "Evening",
                weather: "Clear",
                color_mood: "Warm",
                film_texture: ["35mm grain"],
                environment: "Indoor",
                era_style: "1970s",
                motion_cues: ["Static"],
                reflections: [],
                people_density: "Crowded",
                negative_elements: ["No logos", "No watermark"],
                mood: "Romantic and nostalgic"
            }
        },
        {
            title: "Tokyo neon rain",
            data: {
                subject: "Pedestrians with umbrellas crossing a busy Shibuya intersection, neon signs reflecting on the wet pavement.",
                camera: "Sony a9 (2017)",
                lens: "24-70mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Leading lines"],
                shot_size: "Wide shot (WS)",
                camera_move: ["Push-in"],
                lighting: "Night",
                weather: "Rain",
                color_mood: "Teal-orange",
                film_texture: ["Chromatic aberration"],
                environment: "Urban",
                era_style: "2010s",
                motion_cues: ["Motion blur"],
                reflections: ["Wet pavement", "Neon reflections"],
                people_density: "Crowded",
                negative_elements: ["No text", "No logos"],
                mood: "Energetic and modern"
            }
        },
        {
            title: "Parisian café romance",
            data: {
                subject: "A couple sits at a small table outside a Parisian café, sharing coffee as rain gently falls around them.",
                camera: "Leica M3 (1954)",
                lens: "35mm",
                framing: "Horizontal",
                aspect_ratio: "3:2",
                composition: ["Rule of thirds"],
                shot_size: "Medium shot (MS)",
                camera_move: ["Static"],
                lighting: "Afternoon",
                weather: "Drizzle",
                color_mood: "Pastel",
                film_texture: ["35mm grain"],
                environment: "Urban",
                era_style: "1960s",
                motion_cues: ["Static"],
                reflections: ["Wet pavement"],
                people_density: "Sparse",
                negative_elements: ["No logos"],
                mood: "Romantic and whimsical"
            }
        },
        {
            title: "Favela chase",
            data: {
                subject: "Two teenagers race through the narrow alleys of a Brazilian favela, laundry lines overhead and vibrant murals on the walls.",
                camera: "Canon 5D Mark II (2008)",
                lens: "24-105mm",
                framing: "Horizontal",
                aspect_ratio: "2.39:1",
                composition: ["Leading lines", "Dutch angle"],
                shot_size: "Medium shot (MS)",
                camera_move: ["Handheld", "Tracking shot"],
                lighting: "Afternoon",
                weather: "Clear",
                color_mood: "Vibrant",
                film_texture: ["Chromatic aberration"],
                environment: "Urban",
                era_style: "2000s",
                motion_cues: ["Motion blur", "Rack focus"],
                reflections: [],
                people_density: "Normal",
                negative_elements: ["No logos"],
                mood: "Energetic and gritty"
            }
        },
        {
            title: "Labyrinth dream forest",
            data: {
                subject: "A young girl explores an ancient, moss-covered forest where glowing fairies hover between twisted trees.",
                camera: "Pentax Spotmatic (1964)",
                lens: "50mm",
                framing: "Vertical",
                aspect_ratio: "9:16",
                composition: ["Frame within a frame", "Negative space"],
                shot_size: "Medium close-up (MCU)",
                camera_move: ["Pull-out"],
                lighting: "Dusk",
                weather: "Fog",
                color_mood: "Pastel",
                film_texture: ["Bloom", "Halation"],
                environment: "Forest",
                era_style: "Contemporary",
                motion_cues: ["Slow motion"],
                reflections: [],
                people_density: "Empty",
                negative_elements: ["No text", "No watermark"],
                mood: "Mystical and melancholic"
            }
        },
        {
            title: "Roma street life",
            data: {
                subject: "Children play in a puddled Mexico City street as laundry hangs above and a black-and-white palette evokes the 1970s.",
                camera: "Canon AE-1 (1976)",
                lens: "35mm",
                framing: "Horizontal",
                aspect_ratio: "4:3",
                composition: ["Rule of thirds"],
                shot_size: "Medium wide shot (MWS)",
                camera_move: ["Static"],
                lighting: "Morning",
                weather: "Cloudy",
                color_mood: "Monochrome",
                film_texture: ["35mm grain"],
                environment: "Urban",
                era_style: "1970s",
                motion_cues: ["Freeze action"],
                reflections: ["Puddles"],
                people_density: "Sparse",
                negative_elements: ["No logos", "No text"],
                mood: "Melancholic and nostalgic"
            }
        },
        {
            title: "Anime street festival",
            data: {
                subject: "Cosplayers fill a bustling Japanese street festival with lanterns and cherry blossoms overhead.",
                camera: "Sony a7 (2013)",
                lens: "50mm",
                framing: "Horizontal",
                aspect_ratio: "16:9",
                composition: ["Centered"],
                shot_size: "Group shot",
                camera_move: ["Handheld"],
                lighting: "Afternoon",
                weather: "Clear",
                color_mood: "Colourful",
                film_texture: ["Bokeh"],
                environment: "Urban",
                era_style: "2010s",
                motion_cues: ["Slow motion"],
                reflections: ["Glass"],
                people_density: "Crowded",
                negative_elements: ["No logos"],
                mood: "Joyful and whimsical"
            }
        }
    ];

    // Utility function: join an array into a human‑readable list
    function formatList(arr) {
        if (!arr || arr.length === 0) return "";
        if (arr.length === 1) return arr[0];
        const allButLast = arr.slice(0, arr.length - 1);
        return allButLast.join(", ") + " and " + arr[arr.length - 1];
    }

    // Populate camera type dropdown
    function populateCameraType() {
        const typeSel = document.getElementById('camera_type');
        typeSel.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'None';
        typeSel.appendChild(none);
        CAMERA_TYPES.forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            typeSel.appendChild(opt);
        });
    }

    // Populate camera model dropdown based on selected type
    function populateCameraOptions(type) {
        const camSel = document.getElementById('camera');
        camSel.innerHTML = '';
        const noneOpt = document.createElement('option');
        noneOpt.value = '';
        noneOpt.textContent = 'None';
        camSel.appendChild(noneOpt);
        if (!type || !CAMERAS_BY_TYPE[type]) return;
        CAMERAS_BY_TYPE[type].forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            camSel.appendChild(opt);
        });
    }

    // Populate lens type dropdown
    function populateLensType() {
        const typeSel = document.getElementById('lens_type');
        typeSel.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'None';
        typeSel.appendChild(none);
        Object.keys(LENS_TYPES).forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            typeSel.appendChild(opt);
        });
    }

    // Populate lens focal lengths or names based on selected lens type
    function populateLensOptions(type) {
        const lensSel = document.getElementById('lens');
        lensSel.innerHTML = '';
        const none = document.createElement('option');
        none.value = '';
        none.textContent = 'None';
        lensSel.appendChild(none);
        if (!type || !LENS_TYPES[type]) return;
        LENS_TYPES[type].forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            lensSel.appendChild(opt);
        });
    }

    // Build a group of checkboxes for negative prompts
    function populateNegativeCheckboxes() {
        const container = document.getElementById('negative-checkboxes');
        if (!container) return;
        container.innerHTML = '';
        NEGATIVE_ELEMENTS.forEach(item => {
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = item.name;
            // Use title attribute to show description on hover
            checkbox.title = item.desc;
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(' ' + item.name));
            label.style.marginRight = '8px';
            container.appendChild(label);
        });
    }

    // Populate dropdowns and multi-select lists
    function populateSelect(id, options) {
        const select = document.getElementById(id);
        select.innerHTML = '';
        // Always include a None option
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = 'None';
        select.appendChild(noneOption);
        if (Array.isArray(options)) {
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }
    }

    function populateSelectWithTooltip(id, items) {
        const select = document.getElementById(id);
        select.innerHTML = '';
        // Include a None option
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = 'None';
        noneOption.title = 'No selection';
        select.appendChild(noneOption);
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.name;
            option.textContent = item.name;
            option.title = item.desc;
            select.appendChild(option);
        });
    }

    // Load presets from localStorage; if none, insert default presets
    function getPresets() {
        const saved = localStorage.getItem('prompt_presets');
        let presets = [];
        if (saved) {
            try {
                presets = JSON.parse(saved);
            } catch (e) {
                presets = [];
            }
        }
        if (presets.length < DEFAULT_PRESETS.length) {
            // Merge default presets that aren't already stored
            const existingTitles = new Set(presets.map(p => p.title));
            DEFAULT_PRESETS.forEach(preset => {
                if (!existingTitles.has(preset.title)) {
                    presets.push(preset);
                }
            });
            // Save merged presets
            localStorage.setItem('prompt_presets', JSON.stringify(presets));
        }
        return presets;
    }

    // Refresh preset dropdown options
    function refreshPresetSelect() {
        const presetSelect = document.getElementById('preset_select');
        const presets = getPresets();
        presetSelect.innerHTML = "";
        presets.forEach((preset, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = preset.title;
            presetSelect.appendChild(option);
        });
    }

    // Fill form fields with preset data
    function loadPreset(index) {
        const presets = getPresets();
        if (index < 0 || index >= presets.length) return;
        const data = presets[index].data;
        // Subject
        document.getElementById('subject').value = data.subject || '';
        // Rebuild camera and lens lists and assign values
        populateCameraType();
        populateLensType();
        // Determine camera type from stored camera model
        let camType = '';
        if (data.camera) {
            for (const [type, list] of Object.entries(CAMERAS_BY_TYPE)) {
                if (list.includes(data.camera)) { camType = type; break; }
            }
        }
        document.getElementById('camera_type').value = camType || '';
        populateCameraOptions(camType || '');
        document.getElementById('camera').value = data.camera || '';
        // Determine lens type from stored lens
        let lensType = '';
        if (data.lens) {
            for (const [type, list] of Object.entries(LENS_TYPES)) {
                if (list.includes(data.lens)) { lensType = type; break; }
            }
        }
        document.getElementById('lens_type').value = lensType || '';
        populateLensOptions(lensType || '');
        document.getElementById('lens').value = data.lens || '';
        // Simple selects
        document.getElementById('framing').value = data.framing || '';
        document.getElementById('aspect_ratio').value = data.aspect_ratio || '';
        document.getElementById('shot_size').value = data.shot_size || '';
        // Multi-select camera moves
        const cameraMoveSel = document.getElementById('camera_move');
        for (let i = 0; i < cameraMoveSel.options.length; i++) cameraMoveSel.options[i].selected = false;
        (data.camera_move || []).forEach(val => {
            const opt = Array.from(cameraMoveSel.options).find(o => o.value === val);
            if (opt) opt.selected = true;
        });
        document.getElementById('lighting').value = data.lighting || '';
        document.getElementById('weather').value = data.weather || '';
        document.getElementById('color_mood').value = data.color_mood || '';
        document.getElementById('environment').value = data.environment || '';
        document.getElementById('era_style').value = data.era_style || '';
        document.getElementById('people_density').value = data.people_density || '';
        // Details fields
        document.getElementById('lightingDetails').value = data.lightingDetails || '';
        document.getElementById('weatherDetails').value = data.weatherDetails || '';
        document.getElementById('colorMoodDetails').value = data.colorMoodDetails || '';
        document.getElementById('filmTextureDetails').value = data.filmTextureDetails || '';
        document.getElementById('environmentDetails').value = data.environmentDetails || '';
        document.getElementById('eraStyleDetails').value = data.eraStyleDetails || '';
        document.getElementById('motionCuesDetails').value = data.motionCuesDetails || '';
        document.getElementById('reflectionsDetails').value = data.reflectionsDetails || '';
        document.getElementById('peopleDensityDetails').value = data.peopleDensityDetails || '';
        document.getElementById('negativeDetails').value = data.negativeDetails || '';
        // Multi-select lists helper
        function setMultiSelect(id, values) {
            const select = document.getElementById(id);
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = values.includes(select.options[i].value);
            }
        }
        setMultiSelect('composition', data.composition || []);
        // film texture multi-select
        const ftSel = document.getElementById('film_texture');
        for (let i = 0; i < ftSel.options.length; i++) ftSel.options[i].selected = false;
        (data.film_texture || []).forEach(val => {
            const opt = Array.from(ftSel.options).find(o => o.value === val);
            if (opt) opt.selected = true;
        });
        setMultiSelect('motion_cues', data.motion_cues || []);
        setMultiSelect('reflections', data.reflections || []);
        // Negative elements via checkboxes
        document.querySelectorAll('#negative-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        (data.negative_elements || []).forEach(val => {
            const cb = Array.from(document.querySelectorAll('#negative-checkboxes input[type="checkbox"]')).find(c => c.value === val);
            if (cb) cb.checked = true;
        });
        // Mood: set checkboxes and details
        document.querySelectorAll('#mood-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        if (data.mood) {
            // Attempt to parse mood string into known values and extra
            // Remove parentheses content first
            const moodClean = data.mood.replace(/\s*\([^\)]*\)\s*/g, '');
            const parts = moodClean.split(/,| and /).map(s => s.trim()).filter(s => s);
            const knownMoods = new Set(Array.from(document.querySelectorAll('#mood-checkboxes input[type="checkbox"]')).map(cb => cb.value));
            const extras = [];
            parts.forEach(p => {
                if (knownMoods.has(p)) {
                    const cb = document.querySelector(`#mood-checkboxes input[value="${p}"]`);
                    if (cb) cb.checked = true;
                } else {
                    extras.push(p);
                }
            });
            // Extract details from parentheses if present or extras
            const detailMatch = data.mood.match(/\(([^\)]*)\)/);
            const detail = detailMatch ? detailMatch[1].trim() : '';
            const extraDetail = extras.join(', ');
            document.getElementById('moodDetails').value = [extraDetail, detail].filter(s => s).join(', ');
        } else {
            document.getElementById('moodDetails').value = '';
        }
        // Set custom fields
        document.getElementById('compositionDetails').value = data.compositionDetails || '';
        document.getElementById('shotSizeDetails').value = data.shotSizeDetails || '';
        document.getElementById('cameraMoveDetails').value = data.cameraMoveDetails || '';
    }

    // Generate prompt text
    function generatePrompt() {
        const subject = document.getElementById('subject').value.trim();
        // Mood checkboxes
        const moodCheckboxes = document.querySelectorAll('#mood-checkboxes input[type="checkbox"]:checked');
        const moodValues = Array.from(moodCheckboxes).map(cb => cb.value);
        const moodDetails = document.getElementById('moodDetails').value.trim();
        const camera = document.getElementById('camera').value;
        const lens = document.getElementById('lens').value;
        const framing = document.getElementById('framing').value;
        const aspect = document.getElementById('aspect_ratio').value;
        let composition = Array.from(document.getElementById('composition').selectedOptions).map(opt => opt.value).filter(v => v);
        // Include custom composition text
        const compositionDetails = document.getElementById('compositionDetails').value.trim();
        if (compositionDetails) composition.push(compositionDetails);
        const shotSize = document.getElementById('shot_size').value;
        const shotSizeDetails = document.getElementById('shotSizeDetails').value.trim();
        // Gather multiple camera movements
        const cameraMoves = Array.from(document.getElementById('camera_move').selectedOptions).map(opt => opt.value).filter(v => v);
        const cameraMoveDetails = document.getElementById('cameraMoveDetails').value.trim();
        const lighting = document.getElementById('lighting').value;
        const lightingDetails = document.getElementById('lightingDetails').value.trim();
        const weather = document.getElementById('weather').value;
        const weatherDetails = document.getElementById('weatherDetails').value.trim();
        const colorMood = document.getElementById('color_mood').value;
        const colorMoodDetails = document.getElementById('colorMoodDetails').value.trim();
        const filmTexture = Array.from(document.getElementById('film_texture').selectedOptions).map(opt => opt.value).filter(v => v);
        const filmTextureDetails = document.getElementById('filmTextureDetails').value.trim();
        const environment = document.getElementById('environment').value;
        const environmentDetails = document.getElementById('environmentDetails').value.trim();
        const eraStyle = document.getElementById('era_style').value;
        const eraStyleDetails = document.getElementById('eraStyleDetails').value.trim();
        const motionCues = Array.from(document.getElementById('motion_cues').selectedOptions).map(opt => opt.value).filter(v => v);
        const motionCuesDetails = document.getElementById('motionCuesDetails').value.trim();
        const reflections = Array.from(document.getElementById('reflections').selectedOptions).map(opt => opt.value).filter(v => v);
        const reflectionsDetails = document.getElementById('reflectionsDetails').value.trim();
        const peopleDensity = document.getElementById('people_density').value;
        const peopleDensityDetails = document.getElementById('peopleDensityDetails').value.trim();
        const negativeElements = Array.from(document.querySelectorAll('#negative-checkboxes input[type="checkbox"]:checked')).map(cb => cb.value);
        const negativeDetails = document.getElementById('negativeDetails').value.trim();

        let parts = [];
        if (subject) {
            const capSubject = subject.charAt(0).toUpperCase() + subject.slice(1);
            parts.push(capSubject);
        }
        if (camera) {
            let cameraStr = `It is captured using a ${camera}`;
            if (lens) cameraStr += ` with a ${lens} lens`;
            cameraStr += ".";
            parts.push(cameraStr);
        }
        if ((framing && framing !== 'None') || (aspect && aspect !== 'None')) {
            let framingStr = '';
            if (framing && framing !== 'None') framingStr += `Shot in a ${framing.toLowerCase()} orientation`;
            if (aspect && aspect !== 'None') framingStr += (framingStr ? ' (' : '') + `${aspect} aspect ratio` + (framingStr ? ')' : '');
            framingStr += '.';
            parts.push(framingStr);
        }
        if (composition.length > 0) {
            parts.push(`Composed using ${formatList(composition)}.`);
        }
        // Shot size combined with optional details
        if ((shotSize && shotSize !== 'None') || shotSizeDetails) {
            let ssStr = '';
            if (shotSize && shotSize !== 'None') ssStr += shotSize.toLowerCase();
            if (shotSizeDetails) ssStr += (ssStr ? ' (' : '') + shotSizeDetails + (ssStr ? ')' : '');
            parts.push(`The framing is ${ssStr}.`);
        }
        // Camera movement combined with optional details
        if (cameraMoves.length > 0 || cameraMoveDetails) {
            let cmStr = '';
            if (cameraMoves.length > 0) cmStr += formatList(cameraMoves).toLowerCase();
            if (cameraMoveDetails) cmStr += (cmStr ? ' (' : '') + cameraMoveDetails + (cmStr ? ')' : '');
            parts.push(`Camera movement: ${cmStr}.`);
        }
        // Lighting and weather with details
        if ((lighting && lighting !== 'None') || lightingDetails || (weather && weather !== 'None') || weatherDetails) {
            let lightStr = '';
            if (lighting && lighting !== 'None') lightStr += lighting;
            if (lightingDetails) lightStr += (lightStr ? ' (' : '') + lightingDetails + (lightStr ? ')' : '');
            let weatherStr = '';
            if (weather && weather !== 'None') weatherStr += weather.toLowerCase();
            if (weatherDetails) weatherStr += (weatherStr ? ' (' : '') + weatherDetails + (weatherStr ? ')' : '');
            const combined = [lightStr, weatherStr].filter(s => s).join(', ');
            if (combined) parts.push(`Lighting and atmosphere: ${combined}.`);
        }
        // Colour mood
        if ((colorMood && colorMood !== 'None') || colorMoodDetails) {
            let cmStr = '';
            if (colorMood && colorMood !== 'None') cmStr += colorMood.toLowerCase();
            if (colorMoodDetails) cmStr += (cmStr ? ' (' : '') + colorMoodDetails + (cmStr ? ')' : '');
            parts.push(`The colour mood is ${cmStr}.`);
        }
        // Film texture with details
        if (filmTexture.length > 0 || filmTextureDetails) {
            let ftStr = '';
            if (filmTexture.length > 0) ftStr += formatList(filmTexture);
            if (filmTextureDetails) ftStr += (ftStr ? ' (' : '') + filmTextureDetails + (ftStr ? ')' : '');
            parts.push(`Film texture features ${ftStr}.`);
        }
        // Environment
        if ((environment && environment !== 'None') || environmentDetails) {
            let envStr = '';
            if (environment && environment !== 'None') envStr += environment.toLowerCase();
            if (environmentDetails) envStr += (envStr ? ' (' : '') + environmentDetails + (envStr ? ')' : '');
            parts.push(`The scene is set in a ${envStr} environment.`);
        }
        // Era/style
        if ((eraStyle && eraStyle !== 'None') || eraStyleDetails) {
            let eraStr = '';
            if (eraStyle && eraStyle !== 'None') eraStr += eraStyle;
            if (eraStyleDetails) eraStr += (eraStr ? ' (' : '') + eraStyleDetails + (eraStr ? ')' : '');
            parts.push(`Era/style: ${eraStr}.`);
        }
        // Motion cues
        if (motionCues.length > 0 || motionCuesDetails) {
            let mcStr = '';
            if (motionCues.length > 0) mcStr += formatList(motionCues);
            if (motionCuesDetails) mcStr += (mcStr ? ' (' : '') + motionCuesDetails + (mcStr ? ')' : '');
            parts.push(`Motion cues: ${mcStr}.`);
        }
        // Reflections/surfaces
        if (reflections.length > 0 || reflectionsDetails) {
            let refStr = '';
            if (reflections.length > 0) refStr += formatList(reflections);
            if (reflectionsDetails) refStr += (refStr ? ' (' : '') + reflectionsDetails + (refStr ? ')' : '');
            parts.push(`Reflections/surfaces include ${refStr}.`);
        }
        // People density
        if ((peopleDensity && peopleDensity !== 'None') || peopleDensityDetails) {
            let pdStr = '';
            if (peopleDensity && peopleDensity !== 'None') pdStr += peopleDensity.toLowerCase();
            if (peopleDensityDetails) pdStr += (pdStr ? ' (' : '') + peopleDensityDetails + (pdStr ? ')' : '');
            parts.push(`People density: ${pdStr}.`);
        }
        // Negative elements
        if (negativeElements.length > 0 || negativeDetails) {
            let negStr = '';
            if (negativeElements.length > 0) negStr += formatList(negativeElements);
            if (negativeDetails) negStr += (negStr ? ' (' : '') + negativeDetails + (negStr ? ')' : '');
            parts.push(`Negative prompts: ${negStr}.`);
        }
        // Mood/atmosphere
        if (moodValues.length > 0 || moodDetails) {
            let moodStr = '';
            if (moodValues.length > 0) moodStr += formatList(moodValues).toLowerCase();
            if (moodDetails) moodStr += (moodStr ? ' (' : '') + moodDetails + (moodStr ? ')' : '');
            parts.push(`Overall mood: ${moodStr}.`);
        }
        // Compose extra metadata summary
        const metadata = [];
        if (aspect && aspect !== 'None') metadata.push(`Aspect ratio ${aspect}`);
        if (negativeElements.length > 0) metadata.push(`Negative prompts: ${formatList(negativeElements)}`);
        let metaStr = '';
        if (metadata.length > 0) metaStr = `\n\nExtra metadata: ${metadata.join('; ')}.`;
        const result = parts.join(' ').trim() + metaStr;
        document.getElementById('output').value = result;
        return result;
    }

    // Copy prompt to clipboard
    function copyPrompt() {
        const output = document.getElementById('output').value;
        if (!output) return;
        navigator.clipboard.writeText(output).then(() => {
            const msg = document.getElementById('copyMessage');
            msg.style.display = 'inline';
            // Hide after 3 seconds
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }

    // Save current configuration as a preset
    function savePreset() {
        const name = document.getElementById('preset_name').value.trim();
        if (!name) {
            alert('Please enter a preset name before saving.');
            return;
        }
        // Gather current selections into a data object, including details and mood checkboxes
        const moodVals = Array.from(document.querySelectorAll('#mood-checkboxes input[type="checkbox"]:checked')).map(cb => cb.value);
        const moodDetailsVal = document.getElementById('moodDetails').value.trim();
        const moodStr = (() => {
            if (moodVals.length === 0 && !moodDetailsVal) return '';
            let m = '';
            if (moodVals.length > 0) m += formatList(moodVals);
            if (moodDetailsVal) m += (m ? ' (' : '') + moodDetailsVal + (m ? ')' : '');
            return m;
        })();
        const data = {
            subject: document.getElementById('subject').value.trim(),
            camera: document.getElementById('camera').value,
            lens: document.getElementById('lens').value,
            framing: document.getElementById('framing').value,
            aspect_ratio: document.getElementById('aspect_ratio').value,
            // Save composition selections and custom composition
            composition: (() => {
                const selected = Array.from(document.getElementById('composition').selectedOptions).map(o => o.value).filter(v => v);
                const extra = document.getElementById('compositionDetails').value.trim();
                return extra ? selected.concat(extra) : selected;
            })(),
            // Save shot size and details separately for clarity
            shot_size: document.getElementById('shot_size').value,
            shotSizeDetails: document.getElementById('shotSizeDetails').value.trim(),
            // Camera movement as array and custom details
            camera_move: Array.from(document.getElementById('camera_move').selectedOptions).map(o => o.value).filter(v => v),
            cameraMoveDetails: document.getElementById('cameraMoveDetails').value.trim(),
            lighting: document.getElementById('lighting').value,
            lightingDetails: document.getElementById('lightingDetails').value.trim(),
            weather: document.getElementById('weather').value,
            weatherDetails: document.getElementById('weatherDetails').value.trim(),
            color_mood: document.getElementById('color_mood').value,
            colorMoodDetails: document.getElementById('colorMoodDetails').value.trim(),
            film_texture: Array.from(document.getElementById('film_texture').selectedOptions).map(o => o.value).filter(v => v),
            filmTextureDetails: document.getElementById('filmTextureDetails').value.trim(),
            environment: document.getElementById('environment').value,
            environmentDetails: document.getElementById('environmentDetails').value.trim(),
            era_style: document.getElementById('era_style').value,
            eraStyleDetails: document.getElementById('eraStyleDetails').value.trim(),
            motion_cues: Array.from(document.getElementById('motion_cues').selectedOptions).map(o => o.value).filter(v => v),
            motionCuesDetails: document.getElementById('motionCuesDetails').value.trim(),
            reflections: Array.from(document.getElementById('reflections').selectedOptions).map(o => o.value).filter(v => v),
            reflectionsDetails: document.getElementById('reflectionsDetails').value.trim(),
            people_density: document.getElementById('people_density').value,
            peopleDensityDetails: document.getElementById('peopleDensityDetails').value.trim(),
            // Negative elements from checkboxes
            negative_elements: Array.from(document.querySelectorAll('#negative-checkboxes input[type="checkbox"]:checked')).map(cb => cb.value),
            negativeDetails: document.getElementById('negativeDetails').value.trim(),
            // Persist mood string assembled above
            mood: moodStr,
            // Persist custom composition, shot size and camera movement details for editing
            compositionDetails: document.getElementById('compositionDetails').value.trim()
        };
        // Load existing presets
        const presets = getPresets();
        // Check for duplicate title
        const exists = presets.find(p => p.title.toLowerCase() === name.toLowerCase());
        if (exists) {
            if (!confirm('A preset with this name already exists. Replace it?')) {
                return;
            }
            // Replace the existing preset
            exists.data = data;
        } else {
            // Add new preset
            presets.push({ title: name, data });
        }
        // Persist to localStorage
        localStorage.setItem('prompt_presets', JSON.stringify(presets));
        // Refresh the dropdown
        refreshPresetSelect();
        // Clear preset name field
        document.getElementById('preset_name').value = '';
        alert('Preset saved.');
    }

    // Bind events and initialise the form
    window.addEventListener('DOMContentLoaded', () => {
        // Populate camera and lens selects with nested types
        populateCameraType();
        populateCameraOptions('');
        populateLensType();
        populateLensOptions('');
        // Populate the rest of the dropdowns and lists
        populateSelect('framing', FRAMINGS);
        populateSelect('aspect_ratio', ASPECT_RATIOS);
        populateSelectWithTooltip('composition', COMPOSITIONS);
        populateSelectWithTooltip('shot_size', SHOT_SIZES);
        populateSelectWithTooltip('camera_move', CAMERA_MOVES);
        populateSelect('lighting', LIGHTING_TIMES);
        populateSelect('weather', WEATHERS);
        // Use tooltip-aware population for colour mood
        populateSelectWithTooltip('color_mood', COLOR_MOODS);
        // Film texture multi-select
        const filmTextureSelect = document.getElementById('film_texture');
        filmTextureSelect.innerHTML = '';
        const ftNone = document.createElement('option');
        ftNone.value = '';
        ftNone.textContent = 'None';
        filmTextureSelect.appendChild(ftNone);
        FILM_TEXTURES.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item;
            opt.textContent = item;
            filmTextureSelect.appendChild(opt);
        });
        populateSelect('environment', ENVIRONMENTS);
        populateSelect('era_style', ERAS_STYLES);
        populateSelectWithTooltip('motion_cues', MOTION_CUES);
        populateSelect('reflections', REFLECTIONS);
        populateSelect('people_density', PEOPLE_DENSITY);
        // Build negative element checkboxes instead of multi-select
        populateNegativeCheckboxes();
        // Load presets into dropdown
        refreshPresetSelect();
        // Event listeners for nested selects
        document.getElementById('camera_type').addEventListener('change', (e) => {
            populateCameraOptions(e.target.value);
        });
        document.getElementById('lens_type').addEventListener('change', (e) => {
            populateLensOptions(e.target.value);
        });
        // Event listeners for buttons
        document.getElementById('generateBtn').addEventListener('click', generatePrompt);
        document.getElementById('copyBtn').addEventListener('click', copyPrompt);
        document.getElementById('clearBtn').addEventListener('click', clearForm);
        document.getElementById('loadPresetBtn').addEventListener('click', () => {
            const index = parseInt(document.getElementById('preset_select').value);
            if (!isNaN(index)) loadPreset(index);
        });
        document.getElementById('savePresetBtn').addEventListener('click', savePreset);
        // Keyboard shortcuts: Ctrl+Enter to generate, Ctrl+C to copy
        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                generatePrompt();
                event.preventDefault();
            }
            if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'c') {
                copyPrompt();
                event.preventDefault();
            }
        });
        // Auto-resize subject textarea as the user types.  Ensures the subject/action field grows
        // vertically to accommodate long descriptions without introducing scrollbars.
        const subjectTextarea = document.getElementById('subject');
        if (subjectTextarea) {
            const autoResize = () => {
                subjectTextarea.style.height = 'auto';
                subjectTextarea.style.height = (subjectTextarea.scrollHeight + 2) + 'px';
            };
            autoResize();
            subjectTextarea.addEventListener('input', autoResize);
        }
    });

    // Clear all selections and inputs
    function clearForm() {
        // Reset subject and mood details
        document.getElementById('subject').value = '';
        document.getElementById('moodDetails').value = '';
        // Uncheck mood checkboxes
        document.querySelectorAll('#mood-checkboxes input[type="checkbox"]').forEach(cb => { cb.checked = false; });
        // Reset camera and lens selects via our populate functions
        populateCameraType();
        populateCameraOptions('');
        populateLensType();
        populateLensOptions('');
        // Explicitly select the "None" option for both type and model selects
        const camTypeSel = document.getElementById('camera_type');
        if (camTypeSel) camTypeSel.selectedIndex = 0;
        const camSel = document.getElementById('camera');
        if (camSel) camSel.selectedIndex = 0;
        const lensTypeSel = document.getElementById('lens_type');
        if (lensTypeSel) lensTypeSel.selectedIndex = 0;
        const lensSel = document.getElementById('lens');
        if (lensSel) lensSel.selectedIndex = 0;
        // Reset other selects
        ['framing','aspect_ratio','lighting','weather','color_mood','environment','era_style','people_density'].forEach(id => {
            const sel = document.getElementById(id);
            if (sel) sel.selectedIndex = 0;
        });
        // Reset multi-selects (composition, shot_size, camera_move, motion_cues, reflections, film_texture)
        ['composition','shot_size','camera_move','motion_cues','reflections','film_texture'].forEach(id => {
            const sel = document.getElementById(id);
            if (sel) {
                for (let i = 0; i < sel.options.length; i++) {
                    sel.options[i].selected = false;
                }
                // Select 'None' option if exists
                if (sel.options.length > 0 && sel.options[0].value === '') {
                    sel.options[0].selected = true;
                }
            }
        });
        // Uncheck negative elements
        document.querySelectorAll('#negative-checkboxes input[type="checkbox"]').forEach(cb => { cb.checked = false; });
        // Reset details fields
        ['lightingDetails','weatherDetails','colorMoodDetails','filmTextureDetails','environmentDetails','eraStyleDetails','motionCuesDetails','reflectionsDetails','peopleDensityDetails','negativeDetails','compositionDetails','shotSizeDetails','cameraMoveDetails'].forEach(id => {
            const input = document.getElementById(id);
            if (input) input.value = '';
        });
        // Clear output and hide copy message
        document.getElementById('output').value = '';
        document.getElementById('copyMessage').style.display = 'none';
    }
    </script>
</body>
</html>